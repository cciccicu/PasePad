<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‘å‰ªè´´æ¿</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/node_modules/vditor/dist/index.css">
  <script src="/node_modules/vditor/dist/index.min.js"></script>
  <script src="/js/utils.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>äº‘å‰ªè´´æ¿</h1>
      <% if (authenticated) { %>
      <div class="auth-status authenticated">å·²è®¤è¯ âœ“</div>
      <div class="admin-link">
        <a href="/admin" class="btn btn-admin">ç®¡ç†é¡µé¢</a>
      </div>
      <% } else { %>
      <div class="auth-status">æœªè®¤è¯</div>
      <% } %>
      
      <!-- ç§»åŠ¨ç«¯æ ‡é¢˜æ èœå• -->
      <div class="mobile-header-menu">
        <div class="mobile-header-menu-button" onclick="toggleHeaderMenu()">
          <span class="menu-icon">â‰¡</span>
        </div>
        <div class="mobile-header-dropdown" id="headerMenu">
          <% if (authenticated) { %>
          <a href="/admin"><span class="menu-icon">âš™</span> ç®¡ç†é¡µé¢</a>
          <% } %>
          <button onclick="showModal('markdownModal')"><span class="menu-icon">ğŸ“</span> æ–°å»º Markdown</button>
          <button onclick="showModal('textModal')"><span class="menu-icon">ğŸ“„</span> æ–°å»ºæ–‡æœ¬</button>
          <button onclick="showModal('linkModal')"><span class="menu-icon">ğŸ”—</span> æ–°å»ºé“¾æ¥</button>
          <button onclick="showModal('fileModal')"><span class="menu-icon">ğŸ“</span> ä¸Šä¼ æ–‡ä»¶</button>
        </div>
      </div>
    </header>

    <main>
      <div class="clipboard-list">
        <% if (items && items.length > 0) { %>
          <% items.forEach(item => { %>
            <div class="clipboard-item <%= item.type %>" data-id="<%= item.id %>" data-type="<%= item.type %>">
              <div class="item-header">
                <div class="item-title-container">
                  <span class="item-type-badge <%= item.type %>">
                    <% if (item.type === 'markdown') { %>Markdown<% } %>
                    <% if (item.type === 'text') { %>æ–‡æœ¬<% } %>
                    <% if (item.type === 'link') { %>é“¾æ¥<% } %>
                    <% if (item.type === 'file') { %>æ–‡ä»¶<% } %>
                  </span>
                  <h3 class="item-title"><%= item.title %></h3>
                  <span class="item-date"><%= formatDateTime(item.created_at) %></span>
                </div>
                
                <div class="item-actions">
                  <% if (item.type === 'markdown' || item.type === 'text') { %>
                    <button class="btn-copy" onclick="copyContent('<%= item.id %>')">å¤åˆ¶</button>
                    <button class="btn-share" onclick="shareItem('<%= item.id %>')">åˆ†äº«</button>
                    <% if (authenticated) { %>
                    <button class="btn-edit" onclick="editItem('<%= item.id %>')">ç¼–è¾‘</button>
                    <button class="btn-delete" onclick="deleteItem('<%= item.id %>')">åˆ é™¤</button>
                    <% } %>
                  <% } else if (item.type === 'link') { %>
                    <button class="btn-open" onclick="openLink('<%= item.id %>')">æ‰“å¼€</button>
                    <button class="btn-copy" onclick="copyContent('<%= item.id %>')">å¤åˆ¶</button>
                    <button class="btn-share" onclick="shareItem('<%= item.id %>')">åˆ†äº«</button>
                    <% if (authenticated) { %>
                    <button class="btn-edit" onclick="editItem('<%= item.id %>')">ç¼–è¾‘</button>
                    <button class="btn-delete" onclick="deleteItem('<%= item.id %>')">åˆ é™¤</button>
                    <% } %>
                  <% } else if (item.type === 'file') { %>
                    <button class="btn-copy" onclick="copyFileLink('<%= item.id %>')">å¤åˆ¶é“¾æ¥</button>
                    <button class="btn-share" onclick="shareItem('<%= item.id %>')">åˆ†äº«</button>
                    <button class="btn-info" onclick="showFileInfo('<%= item.id %>')">ä¿¡æ¯</button>
                    <% if (authenticated) { %>
                    <button class="btn-delete" onclick="deleteItem('<%= item.id %>')">åˆ é™¤</button>
                    <% } %>
                  <% } %>
              </div>
              
              <!-- ç§»åŠ¨ç«¯ä¸‰ç‚¹èœå•æŒ‰é’® -->
              <div class="mobile-menu-button" onclick="toggleMobileMenu('<%= item.id %>', event)">
                <span class="menu-icon">â‹®</span>
              </div>
              
              <!-- ç§»åŠ¨ç«¯æ“ä½œèœå• -->
              <div class="mobile-action-menu" id="mobileMenu<%= item.id %>">
                <!-- æ—¥æœŸä¿¡æ¯æ˜¾ç¤ºåœ¨èœå•é¡¶éƒ¨ -->
                <div class="mobile-menu-date"><span class="menu-icon">ğŸ•’</span> <%= formatDateTime(item.created_at) %></div>
                
                <% if (item.type === 'markdown' || item.type === 'text') { %>
                  <button onclick="copyContent('<%= item.id %>')"><span class="menu-icon">ğŸ“‹</span> å¤åˆ¶</button>
                  <button onclick="shareItem('<%= item.id %>')"><span class="menu-icon">ğŸ”—</span> åˆ†äº«</button>
                  <% if (authenticated) { %>
                  <button onclick="editItem('<%= item.id %>')"><span class="menu-icon">âœï¸</span> ç¼–è¾‘</button>
                  <button onclick="deleteItem('<%= item.id %>')"><span class="menu-icon">ğŸ—‘ï¸</span> åˆ é™¤</button>
                  <% } %>
                <% } else if (item.type === 'link') { %>
                  <button onclick="openLink('<%= item.id %>')"><span class="menu-icon">ğŸ”—</span> æ‰“å¼€</button>
                  <button onclick="copyContent('<%= item.id %>')"><span class="menu-icon">ğŸ“‹</span> å¤åˆ¶</button>
                  <button onclick="shareItem('<%= item.id %>')"><span class="menu-icon">ğŸ”—</span> åˆ†äº«</button>
                  <% if (authenticated) { %>
                  <button onclick="editItem('<%= item.id %>')"><span class="menu-icon">âœï¸</span> ç¼–è¾‘</button>
                  <button onclick="deleteItem('<%= item.id %>')"><span class="menu-icon">ğŸ—‘ï¸</span> åˆ é™¤</button>
                  <% } %>
                <% } else if (item.type === 'file') { %>
                  <button onclick="copyFileLink('<%= item.id %>')"><span class="menu-icon">ğŸ“‹</span> å¤åˆ¶é“¾æ¥</button>
                  <button onclick="shareItem('<%= item.id %>')"><span class="menu-icon">ğŸ”—</span> åˆ†äº«</button>
                  <button onclick="showFileInfo('<%= item.id %>')"><span class="menu-icon">â„¹ï¸</span> ä¿¡æ¯</button>
                  <% if (authenticated) { %>
                  <button onclick="deleteItem('<%= item.id %>')"><span class="menu-icon">ğŸ—‘ï¸</span> åˆ é™¤</button>
                  <% } %>
                <% } %>
              </div>
              </div>
              
              <% if (item.type === 'markdown') { %>
                <div class="item-preview markdown-preview" style="display: none;">
                  <div class="vditor-preview"></div>
                </div>
              <% } else if (item.type === 'text') { %>
                <div class="item-preview text-preview" style="display: none;">
                  <pre><%= item.content %></pre>
                </div>
              <% } else if (item.type === 'link') { %>
                <div class="item-preview link-preview" style="display: none;">
                  <div class="link-info">
                    <div class="link-url"></div>
                  </div>
                </div>
              <% } %>
            </div>
          <% }); %>
        <% } else { %>
          <div class="empty-state">
            <p>å‰ªè´´æ¿ä¸ºç©ºï¼Œè¯·æ·»åŠ æ–°å†…å®¹</p>
          </div>
        <% } %>
      </div>
    </main>

    <!-- Markdown æ¨¡æ€æ¡† -->
    <div id="markdownModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('markdownModal')">&times;</span>
        <h2>æ–°å»º Markdown</h2>
        <form action="/create/markdown" method="post">
          <div class="form-group">
            <label for="markdown-title">æ ‡é¢˜</label>
            <input type="text" id="markdown-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="markdown-content">å†…å®¹</label>
            <div id="vditor" class="vditor"></div>
            <input type="hidden" id="markdown-content" name="content">
          </div>
          <div class="form-actions">
            <button type="button" class="btn" onclick="closeModal('markdownModal')">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary" onclick="submitMarkdown()">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- çº¯æ–‡æœ¬æ¨¡æ€æ¡† -->
    <div id="textModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('textModal')">&times;</span>
        <h2>æ–°å»ºçº¯æ–‡æœ¬</h2>
        <form action="/create/text" method="post">
          <div class="form-group">
            <label for="text-title">æ ‡é¢˜</label>
            <input type="text" id="text-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="text-content">å†…å®¹</label>
            <textarea id="text-content" name="content" rows="10" required></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn" onclick="closeModal('textModal')">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- é“¾æ¥æ¨¡æ€æ¡† -->
    <div id="linkModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('linkModal')">&times;</span>
        <h2>æ–°å»ºé“¾æ¥</h2>
        <form action="/create/link" method="post">
          <div class="form-group">
            <label for="link-title">æ ‡é¢˜</label>
            <input type="text" id="link-title" name="title" required>
          </div>
          <div class="form-group">
            <label for="link-content">URL</label>
            <input type="url" id="link-content" name="content" required>
          </div>
          <div class="form-actions">
            <button type="button" class="btn" onclick="closeModal('linkModal')">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <!-- æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="fileModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('fileModal')">&times;</span>
        <h2>æ–°å»ºæ–‡ä»¶</h2>
        <form action="/create/file" method="post" enctype="multipart/form-data">
          <div class="form-group">
            <label for="file-title">æ ‡é¢˜</label>
            <input type="text" id="file-title" name="title" required>
            <small class="form-text">å°†è‡ªåŠ¨ä½¿ç”¨æ–‡ä»¶åä½œä¸ºæ ‡é¢˜</small>
          </div>
          <div class="form-group">
            <label for="file-upload">æ–‡ä»¶</label>
            <input type="file" id="file-upload" name="file" required>
          </div>
          <input type="hidden" id="original-filename" name="original_filename" value="">
          <div class="form-actions">
            <button type="button" class="btn" onclick="closeModal('fileModal')">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">ä¸Šä¼ </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('editModal')">&times;</span>
        <h2>ç¼–è¾‘å†…å®¹</h2>
        <form id="editForm" action="/update/0" method="post">
          <div class="form-group">
            <label for="edit-title">æ ‡é¢˜</label>
            <input type="text" id="edit-title" name="title" required>
          </div>
          <div class="form-group" id="edit-markdown-container" style="display: none;">
            <label for="edit-markdown">å†…å®¹</label>
            <div id="edit-vditor" class="vditor"></div>
          </div>
          <div class="form-group" id="edit-text-container" style="display: none;">
            <label for="edit-text">å†…å®¹</label>
            <textarea id="edit-text" rows="10" required></textarea>
          </div>
          <div class="form-group" id="edit-link-container" style="display: none;">
            <label for="edit-link">é“¾æ¥åœ°å€</label>
            <input type="url" id="edit-link" placeholder="https://example.com" required>
          </div>
          <!-- ç»Ÿä¸€å†…å®¹å­—æ®µ -->
          <input type="hidden" id="edit-content" name="content">

          <div class="form-actions">
            <button type="button" class="btn" onclick="closeModal('editModal')">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary" id="edit-submit-btn">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- æ–‡ä»¶ä¿¡æ¯æ¨¡æ€æ¡† -->
  <div id="fileInfoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('fileInfoModal')">&times;</span>
      <h2>æ–‡ä»¶ä¿¡æ¯</h2>
      <div class="file-info-container">
        <div class="file-properties">
          <h3>å±æ€§ä¿¡æ¯</h3>
          <div id="fileProperties"></div>
        </div>
        <div class="file-preview-container">
          <h3>æ–‡ä»¶é¢„è§ˆ</h3>
          <div id="filePreview"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ‚¬æµ®æŒ‰é’® -->
  <div class="floating-buttons">
    <button class="floating-btn btn-file" onclick="showModal('fileModal')" title="æ–°å»ºæ–‡ä»¶">
      <span>æ–‡ä»¶</span>
    </button>
    <button class="floating-btn btn-link" onclick="showModal('linkModal')" title="æ–°å»ºé“¾æ¥">
      <span>é“¾æ¥</span>
    </button>
    <button class="floating-btn btn-text" onclick="showModal('textModal')" title="æ–°å»ºçº¯æ–‡æœ¬">
      <span>æ–‡æœ¬</span>
    </button>
    <button class="floating-btn btn-markdown" onclick="showModal('markdownModal')" title="æ–°å»ºMarkdown">
      <span>MD</span>
    </button>
  </div>
  
  <!-- ä¸Šä¼ é˜Ÿåˆ—æ‚¬æµ®çƒå’Œé¢æ¿ -->
  <div class="upload-float-ball" id="uploadFloatBall" style="display: none;">
    <span>ğŸ“¤</span>
    <div class="badge" id="uploadBadge">0</div>
  </div>
  <div class="upload-queue-panel" id="uploadQueuePanel">
    <h3>ä¸Šä¼ é˜Ÿåˆ—</h3>
    <div id="uploadItems"></div>
  </div>
  
  <!-- Toasté€šçŸ¥ç³»ç»Ÿ -->
  <div id="toast-container" class="toast-container"></div>
  
  <!-- ç¡®è®¤å¯¹è¯æ¡† -->
  <div id="confirm-dialog" class="modal confirm-dialog">
    <div class="modal-content confirm-content">
      <h3 id="confirm-message">ç¡®è®¤æ“ä½œ</h3>
      <div class="confirm-actions">
        <button id="confirm-cancel" class="btn">å–æ¶ˆ</button>
        <button id="confirm-ok" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let vditor = null;
    let editVditor = null;
    let uploadQueue = [];
    let activeUploads = 0;
    
    // åˆ†äº«é¡¹ç›®
    function shareItem(id) {
      const shareUrl = window.location.origin + '/share/' + id;
      
      // å°è¯•ä½¿ç”¨ç°ä»£Clipboard API
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(shareUrl)
          .then(() => showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
          .catch(err => {
            // å¦‚æœClipboard APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ
            fallbackCopy(shareUrl);
          });
      } else {
        // å¦‚æœClipboard APIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ
        fallbackCopy(shareUrl);
      }
    }
    
    // åˆ‡æ¢ç§»åŠ¨ç«¯é¡¹ç›®æ“ä½œèœå•
    function toggleMobileMenu(itemId, event) {
      // å…ˆå…³é—­æ‰€æœ‰å…¶ä»–èœå•
      document.querySelectorAll('.mobile-action-menu.show').forEach(menu => {
        if (menu.id !== `mobileMenu${itemId}`) {
          menu.classList.remove('show');
        }
      });
      
      // åˆ‡æ¢å½“å‰èœå•
      const menu = document.getElementById(`mobileMenu${itemId}`);
      if (menu) {
        // è·å–ç‚¹å‡»æŒ‰é’®çš„ä½ç½®
        const button = event.currentTarget;
        const buttonRect = button.getBoundingClientRect();
        
        // è®¡ç®—èœå•ä½ç½® - é»˜è®¤æ˜¾ç¤ºåœ¨æŒ‰é’®é™„è¿‘
        // è®¡ç®—æŒ‰é’®ä¸­å¿ƒç‚¹
        const buttonCenterX = buttonRect.left + (buttonRect.width / 2);
        const menuWidth = 200; // ä¼°è®¡çš„èœå•å®½åº¦
        
        // é»˜è®¤å°†èœå•æ”¾åœ¨æŒ‰é’®å³ä¾§ï¼Œä½†é è¿‘æŒ‰é’®
        let left = buttonRect.right - 10;
        let top = buttonRect.top;
        
        // æ£€æŸ¥æ˜¯å¦ä¼šè¶…å‡ºå³ä¾§è¾¹ç•Œ
        if (left + menuWidth > window.innerWidth) {
          // å¦‚æœä¼šè¶…å‡ºå³ä¾§è¾¹ç•Œï¼Œåˆ™å°è¯•å°†èœå•å±…ä¸­æ˜¾ç¤ºåœ¨æŒ‰é’®ä¸‹æ–¹
          left = buttonCenterX - (menuWidth / 2);
          top = buttonRect.bottom + 5;
          
          // ç¡®ä¿èœå•ä¸ä¼šè¶…å‡ºå·¦ä¾§è¾¹ç•Œ
          if (left < 5) {
            left = 5;
          }
          
          // ç¡®ä¿èœå•ä¸ä¼šè¶…å‡ºå³ä¾§è¾¹ç•Œ
          if (left + menuWidth > window.innerWidth - 5) {
            left = window.innerWidth - menuWidth - 5;
          }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¼šè¶…å‡ºåº•éƒ¨è¾¹ç•Œ
        const menuHeight = menu.scrollHeight || 200; // ä¼°è®¡çš„èœå•é«˜åº¦
        if (top + menuHeight > window.innerHeight) {
          // å¦‚æœä¼šè¶…å‡ºåº•éƒ¨è¾¹ç•Œï¼Œåˆ™å‘ä¸Šè°ƒæ•´
          top = Math.max(5, window.innerHeight - menuHeight - 5);
        }
        
        // è®¾ç½®èœå•ä½ç½®
        menu.style.left = `${left}px`;
        menu.style.top = `${top}px`;
        
        // æ˜¾ç¤ºèœå•
        menu.classList.toggle('show');
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
      }
    }
    
    // åˆ‡æ¢æ ‡é¢˜æ èœå•
    function toggleHeaderMenu() {
      const menu = document.getElementById('headerMenu');
      if (menu) {
        menu.classList.toggle('show');
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
      }
    }
    
    // åˆå§‹åŒ–ä¸Šä¼ é˜Ÿåˆ—ç›¸å…³äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      // ä¸ºä¸Šä¼ æ‚¬æµ®çƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
      document.getElementById('uploadFloatBall').addEventListener('click', function() {
        const panel = document.getElementById('uploadQueuePanel');
        panel.classList.toggle('show');
      });
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­æ‰€æœ‰ç§»åŠ¨ç«¯èœå•
      document.addEventListener('click', function(e) {
        // å…³é—­é¡¹ç›®æ“ä½œèœå•
        if (!e.target.closest('.mobile-menu-button') && !e.target.closest('.mobile-action-menu')) {
          document.querySelectorAll('.mobile-action-menu.show').forEach(menu => {
            menu.classList.remove('show');
          });
        }
        
        // å…³é—­æ ‡é¢˜æ èœå•
        if (!e.target.closest('.mobile-header-menu-button') && !e.target.closest('.mobile-header-dropdown')) {
          const headerMenu = document.getElementById('headerMenu');
          if (headerMenu && headerMenu.classList.contains('show')) {
            headerMenu.classList.remove('show');
          }
        }
      });
      
      // æ·»åŠ çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†ï¼Œå…³é—­æ‰€æœ‰èœå•
      window.addEventListener('resize', function() {
        // å…³é—­æ‰€æœ‰æ“ä½œèœå•
        document.querySelectorAll('.mobile-action-menu.show').forEach(menu => {
          menu.classList.remove('show');
        });
        
        // å…³é—­æ ‡é¢˜æ èœå•
        const headerMenu = document.getElementById('headerMenu');
        if (headerMenu && headerMenu.classList.contains('show')) {
          headerMenu.classList.remove('show');
        }
      });
    });
    
    // Toasté€šçŸ¥ç³»ç»Ÿå‡½æ•°
    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      const container = document.getElementById('toast-container');
      container.appendChild(toast);
      
      // æ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // è‡ªåŠ¨å…³é—­
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          container.removeChild(toast);
        }, 300);
      }, duration);
    }
    
    // ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
    function showConfirm(message, onConfirm) {
      const dialog = document.getElementById('confirm-dialog');
      const messageEl = document.getElementById('confirm-message');
      const okButton = document.getElementById('confirm-ok');
      const cancelButton = document.getElementById('confirm-cancel');
      
      // è®¾ç½®æ¶ˆæ¯
      messageEl.textContent = message;
      
      // æ˜¾ç¤ºå¯¹è¯æ¡†
      dialog.style.display = 'block';
      
      // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
      const newOkButton = okButton.cloneNode(true);
      const newCancelButton = cancelButton.cloneNode(true);
      okButton.parentNode.replaceChild(newOkButton, okButton);
      cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
      
      // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
      newOkButton.addEventListener('click', function() {
        dialog.style.display = 'none';
        if (typeof onConfirm === 'function') {
          onConfirm();
        }
      });
      
      newCancelButton.addEventListener('click', function() {
        dialog.style.display = 'none';
      });
    }
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', function() {
      // ä¸ºç¼–è¾‘è¡¨å•æ·»åŠ æäº¤äº‹ä»¶
      document.getElementById('edit-submit-btn').addEventListener('click', submitEdit);
      // åˆå§‹åŒ–Markdownç¼–è¾‘å™¨
      vditor = new Vditor("vditor", {
        height: 360,
        mode: 'wysiwyg',
        placeholder: 'è¯·è¾“å…¥Markdownå†…å®¹...',
        cache: {
          enable: true
        },
        cdn: '/node_modules/vditor/',
        upload: {
          url: '/upload/vditor',
          max: 10 * 1024 * 1024, // 5MB
          accept: 'image/*,audio/*',
          token: '',
          withCredentials: false,
          fieldName: 'file',
          error: (msg) => {
            console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', msg);
          }
        }
      });
      // æ·»åŠ å…¨å±€æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
      setupGlobalDragDrop();
      // æ·»åŠ å…¨å±€ç²˜è´´ä¸Šä¼ åŠŸèƒ½
      setupGlobalPaste();
      
      // ä¸ºæ¯ä¸ªå‰ªè´´æ¿é¡¹ç›®æ·»åŠ ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.clipboard-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸æ‰§è¡Œé¢„è§ˆæ“ä½œ
          if (e.target.tagName === 'BUTTON') return;
          
          // å¦‚æœç‚¹å‡»çš„æ˜¯é¢„è§ˆåŒºåŸŸï¼Œä¸æ‰§è¡Œæ”¶èµ·æ“ä½œ
          if (e.target.closest('.item-preview')) return;
          
          const id = this.dataset.id;
          const type = this.dataset.type;
          
          toggleItem(id);
        });
      });
      
      // åˆ‡æ¢é¡¹ç›®é¢„è§ˆçš„é€šç”¨å‡½æ•°
      function toggleItem(itemId) {
        const item = document.querySelector(`.clipboard-item[data-id="${itemId}"]`);
        if (!item) return;
        
        const type = item.dataset.type;
        
        if (type === 'markdown' || type === 'text') {
          // åˆ‡æ¢é¢„è§ˆæ˜¾ç¤º
          const preview = item.querySelector('.item-preview');
          if (preview.style.display === 'none') {
            preview.style.display = 'block';
            
            // å¦‚æœæ˜¯Markdownï¼Œæ¸²æŸ“å†…å®¹
            if (type === 'markdown') {
              fetch(`/item/${itemId}`)
                .then(response => response.json())
                .then(data => {
                  const previewDiv = preview.querySelector('.vditor-preview');
                  Vditor.preview(previewDiv, data.content, {
                    cdn: '/node_modules/vditor',
                    theme: 'light'
                  });
                });
            }
          } else {
            preview.style.display = 'none';
          }
        } else if (type === 'link') {
          // åˆ‡æ¢é¢„è§ˆæ˜¾ç¤º
          const preview = item.querySelector('.item-preview');
          if (preview.style.display === 'none') {
            preview.style.display = 'block';
            
            // è·å–é“¾æ¥ä¿¡æ¯
            fetch(`/item/${itemId}`)
              .then(response => response.json())
              .then(data => {
                const linkUrlDiv = preview.querySelector('.link-url');
                linkUrlDiv.innerHTML = `<a href="${data.content}" target="_blank">${data.content}</a>`;
              });
          } else {
            preview.style.display = 'none';
          }
        } else if (type === 'file') {
          // è·å–æ–‡ä»¶è·¯å¾„å¹¶ä¸‹è½½
          fetch(`/item/${itemId}`)
            .then(response => response.json())
            .then(data => {
              if (data.file_path) {
                // ç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ŒæœåŠ¡å™¨ä¼šå¤„ç†ä¸‹è½½
                window.location.href = data.file_path;
              }
            });
        }
      }
    });
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    function showModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
    }
    
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // æäº¤Markdownå†…å®¹
    function submitMarkdown() {
      document.getElementById('markdown-content').value = vditor.getValue();
      vditor.setValue('', true);
    }
    
    // æ‰“å¼€é“¾æ¥
    function openLink(id) {
      fetch(`/item/${id}`)
        .then(response => response.json())
        .then(data => {
          window.open(data.content, '_blank');
        });
    }
    
    // ä»é¢„è§ˆåŒºåŸŸæ‰“å¼€é“¾æ¥
    function openLinkFromPreview(id) {
      openLink(id);
    }
    
    // å¤åˆ¶å†…å®¹
    function copyContent(id) {
      fetch(`/item/${id}`)
        .then(response => response.json())
        .then(data => {
          // å°è¯•ä½¿ç”¨ç°ä»£Clipboard API
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(data.content)
              .then(() => showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
              .catch(err => {
                // å¦‚æœClipboard APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ
                fallbackCopy(data.content);
              });
          } else {
            // å¦‚æœClipboard APIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ
            fallbackCopy(data.content);
          }
        });
    }
    
    // å¤åˆ¶å†…å®¹çš„å¤‡é€‰æ–¹æ¡ˆ
    function fallbackCopy(text) {
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
      const textArea = document.createElement('textarea');
      textArea.value = text;
      
      // è®¾ç½®æ ·å¼ä½¿å…¶ä¸å¯è§
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      
      // é€‰æ‹©æ–‡æœ¬å¹¶å¤åˆ¶
      textArea.focus();
      textArea.select();
      
      let success = false;
      try {
        // æ‰§è¡Œå¤åˆ¶å‘½ä»¤
        success = document.execCommand('copy');
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
      }
      
      // ç§»é™¤ä¸´æ—¶å…ƒç´ 
      document.body.removeChild(textArea);
      
      // æç¤ºç”¨æˆ·
      if (success) {
        showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      } else {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
      }
    }
    
    // å¤åˆ¶æ–‡ä»¶é“¾æ¥
    function copyFileLink(id) {
      fetch(`/item/${id}`)
        .then(response => response.json())
        .then(data => {
          if (data.file_path) {
            // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„URLæ ¼å¼
            const fileUrl = window.location.origin + '/' + data.file_path;
            
            // å°è¯•ä½¿ç”¨ç°ä»£Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(fileUrl)
                .then(() => showToast('æ–‡ä»¶é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
                .catch(err => {
                  // å¦‚æœClipboard APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ
                  fallbackCopy(fileUrl);
                });
            } else {
              // å¦‚æœClipboard APIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ
              fallbackCopy(fileUrl);
            }
          }
        });
    }
    
    
    // ç¼–è¾‘é¡¹ç›®
    function editItem(id) {
      // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
      <% if (!authenticated) { %>
        showToast('æ‚¨éœ€è¦å…ˆè¿›è¡Œè®¤è¯æ‰èƒ½ç¼–è¾‘å†…å®¹', 'warning');
        return;
      <% } %>
      
      fetch(`/item/${id}`)
        .then(response => response.json())
        .then(data => {
          // è®¾ç½®è¡¨å•action
          document.getElementById('editForm').action = `/update/${id}`;
          document.getElementById('edit-title').value = data.title;
          
          if (data.type === 'markdown') {
            // æ˜¾ç¤ºMarkdownç¼–è¾‘å™¨
            document.getElementById('edit-markdown-container').style.display = 'block';
            document.getElementById('edit-text-container').style.display = 'none';
            document.getElementById('edit-link-container').style.display = 'none';
            
            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            if (!editVditor) {
              editVditor = new Vditor("edit-vditor", {
                height: 360,
                mode: 'wysiwyg',
                cache: {
                  enable: true
                },
                upload: {
                  url: '/upload/vditor',
                  max: 10 * 1024 * 1024, // 5MB
                  accept: 'image/*,audio/*',
                  token: '',
                  withCredentials: false,
                  fieldName: 'file',
                  error: (msg) => {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', msg);
                  }
                },
                after: () => {
                  editVditor.setValue(data.content);
                }
              });
            } else {
              editVditor.setValue(data.content);
            }
          } else if (data.type === 'text') {
            // æ˜¾ç¤ºçº¯æ–‡æœ¬ç¼–è¾‘å™¨
            document.getElementById('edit-markdown-container').style.display = 'none';
            document.getElementById('edit-text-container').style.display = 'block';
            document.getElementById('edit-link-container').style.display = 'none';
            document.getElementById('edit-text').value = data.content;
          } else if (data.type === 'link') {
            // æ˜¾ç¤ºé“¾æ¥ç¼–è¾‘å™¨
            document.getElementById('edit-markdown-container').style.display = 'none';
            document.getElementById('edit-text-container').style.display = 'none';
            document.getElementById('edit-link-container').style.display = 'block';
            document.getElementById('edit-link').value = data.content;
          }
          
          // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
          showModal('editModal');
        });
    }
    
    // æäº¤ç¼–è¾‘
    function submitEdit(event) {
      // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤
      event.preventDefault();
      
      if (document.getElementById('edit-markdown-container').style.display !== 'none') {
        // Markdownç¼–è¾‘
        const markdownContent = editVditor.getValue();
        // åªè®¾ç½®ç»Ÿä¸€çš„contentå­—æ®µ
        document.getElementById('edit-content').value = markdownContent;
      } else if (document.getElementById('edit-text-container').style.display !== 'none') {
        // çº¯æ–‡æœ¬ç¼–è¾‘
        const textContent = document.getElementById('edit-text').value;
        // åªè®¾ç½®ç»Ÿä¸€çš„contentå­—æ®µ
        document.getElementById('edit-content').value = textContent;
      } else if (document.getElementById('edit-link-container').style.display !== 'none') {
        // é“¾æ¥ç¼–è¾‘
        const linkContent = document.getElementById('edit-link').value;
        // åªè®¾ç½®ç»Ÿä¸€çš„contentå­—æ®µ
        document.getElementById('edit-content').value = linkContent;
      }
      
      // æ‰‹åŠ¨æäº¤è¡¨å•
      document.getElementById('editForm').submit();
    }
    
    // åˆ é™¤é¡¹ç›®
    function deleteItem(id) {
      // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
      <% if (!authenticated) { %>
        showToast('æ‚¨éœ€è¦å…ˆè¿›è¡Œè®¤è¯æ‰èƒ½åˆ é™¤å†…å®¹', 'warning');
        return;
      <% } %>
      
      showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ', function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${id}`;
        document.body.appendChild(form);
        form.submit();
      });
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    function showFileInfo(id) {
      fetch(`/item/${id}`)
        .then(response => response.json())
        .then(data => {
          if (data.file_path) {
            // è·å–æ–‡ä»¶ä¿¡æ¯
            fetch(`/file-info/${id}`)
              .then(response => response.json())
              .then(fileInfo => {
                // å¡«å……å±æ€§ä¿¡æ¯
                const propertiesDiv = document.getElementById('fileProperties');
                let propertiesHTML = '<table>';
                propertiesHTML += `<tr><td>æ–‡ä»¶å</td><td>${fileInfo.name}</td></tr>`;
                propertiesHTML += `<tr><td>å¤§å°</td><td>${formatFileSize(fileInfo.size)}</td></tr>`;
                propertiesHTML += `<tr><td>åˆ›å»ºæ—¥æœŸ</td><td>${formatDateTime(fileInfo.created)}</td></tr>`;
            propertiesHTML += `<tr><td>ä¿®æ”¹æ—¥æœŸ</td><td>${formatDateTime(fileInfo.modified)}</td></tr>`;
                propertiesHTML += `<tr><td>ç±»å‹</td><td>${fileInfo.type}</td></tr>`;
                propertiesHTML += '</table>';
                propertiesDiv.innerHTML = propertiesHTML;
                
                // å¡«å……æ–‡ä»¶é¢„è§ˆ
                const previewDiv = document.getElementById('filePreview');
                const fileType = fileInfo.type.toLowerCase();
                const filePath = '/' + data.file_path;
                
                if (fileType.startsWith('image/')) {
                  // å›¾ç‰‡é¢„è§ˆ
                  previewDiv.innerHTML = `<img src="${filePath}" alt="${fileInfo.name}">`;
                } else if (fileType.startsWith('video/')) {
                  // è§†é¢‘é¢„è§ˆ
                  previewDiv.innerHTML = `<video controls><source src="${filePath}" type="${fileType}">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘é¢„è§ˆ</video>`;
                } else if (fileType.startsWith('audio/')) {
                  // éŸ³é¢‘é¢„è§ˆ
                  previewDiv.innerHTML = `<audio controls><source src="${filePath}" type="${fileType}">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘é¢„è§ˆ</audio>`;
                } else if (isTextFile(fileType) && fileInfo.size < 10 * 1024 * 1024) {
                  // çº¯æ–‡æœ¬æ–‡ä»¶é¢„è§ˆï¼ˆå°äº1MBï¼‰
                  previewDiv.innerHTML = '<div class="text-preview-loading">æ­£åœ¨åŠ è½½æ–‡æœ¬å†…å®¹...</div>';
                  
                  // è·å–æ–‡æœ¬å†…å®¹
                  fetch(`/text-preview/${id}`)
                    .then(response => {
                      if (!response.ok) {
                        throw new Error('æ— æ³•åŠ è½½æ–‡æœ¬å†…å®¹');
                      }
                      return response.json();
                    })
                    .then(data => {
                      // åˆ›å»ºé¢„æ ¼å¼åŒ–æ–‡æœ¬åŒºåŸŸ
                      const textContent = document.createElement('pre');
                      textContent.className = 'text-preview-content';
                      textContent.textContent = data.content;
                      
                      // æ¸…ç©ºåŠ è½½æç¤ºå¹¶æ·»åŠ æ–‡æœ¬å†…å®¹
                      previewDiv.innerHTML = '';
                      previewDiv.appendChild(textContent);
                    })
                    .catch(error => {
                      console.error('åŠ è½½æ–‡æœ¬å†…å®¹å¤±è´¥:', error);
                      previewDiv.innerHTML = `<p class="text-preview-error">æ— æ³•åŠ è½½æ–‡æœ¬å†…å®¹: ${error.message}</p>`;
                    });
                } else {
                  // ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
                  previewDiv.innerHTML = '<p>æš‚ä¸æ”¯æŒæ­¤ç±»å‹æ–‡ä»¶é¢„è§ˆ</p>';
                }
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                showModal('fileInfoModal');
              })
              .catch(error => {
                console.error('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥:', error);
                showToast('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥', 'error');
              });
          }
        });
    }
    
    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡æœ¬æ–‡ä»¶
    function isTextFile(mimeType) {
      const textTypes = [
        'text/plain', 'text/xml', 'application/json', 'text/javascript', 
        'text/x-python', 'text/x-java', 'text/x-c', 'text/x-c++', 'text/x-csharp',
        'text/html', 'text/css', 'text/markdown', 'text/x-sh', 'text/x-sql',
        'text/yaml'
      ];
      return textTypes.includes(mimeType);
    }
    
    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    function checkAuthStatus() {
      // å¦‚æœURLä¸­åŒ…å«å¯†ç å‚æ•°ï¼Œåˆ·æ–°é¡µé¢ä»¥ç§»é™¤URLä¸­çš„å¯†ç 
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('password')) {
        // å»¶è¿Ÿä¸€ç§’ååˆ·æ–°é¡µé¢ï¼Œç§»é™¤URLä¸­çš„å¯†ç å‚æ•°
        setTimeout(() => {
          window.location.href = window.location.pathname;
        }, 1000);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthStatus();
    });
    
    // ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†
    document.getElementById('uploadFloatBall').addEventListener('click', function() {
      document.getElementById('uploadQueuePanel').classList.toggle('show');
    });

    // ç›‘å¬æ–‡ä»¶ä¸Šä¼ è¡¨å•æ‰“å¼€
    document.getElementById('file-upload').addEventListener('change', function() {
      if (this.files.length > 0) {
        // è‡ªåŠ¨å¡«å……æ–‡ä»¶åä½œä¸ºæ ‡é¢˜
        const fileName = this.files[0].name;
        document.getElementById('file-title').value = fileName;
        // ä¿å­˜åŸå§‹æ–‡ä»¶ååˆ°éšè—å­—æ®µ
        document.getElementById('original-filename').value = fileName;
      }
    });
    
    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    document.querySelector('#fileModal form').addEventListener('submit', function(event) {
      event.preventDefault();
      
      const title = document.getElementById('file-title').value;
      const fileInput = document.getElementById('file-upload');
      const formData = new FormData(this);
      
      if (!fileInput.files.length) {
        showToast('è¯·é€‰æ‹©æ–‡ä»¶', 'warning');
        return;
      }
      
      const file = fileInput.files[0];
      const uploadId = Date.now();
      
      // æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—
      addToUploadQueue(uploadId, title, file.name);
      
      // ç¡®ä¿ä¸Šä¼ æ‚¬æµ®çƒå’Œé¢æ¿æ˜¾ç¤º
      document.getElementById('uploadFloatBall').style.display = 'flex';
      document.getElementById('uploadQueuePanel').classList.add('show');
      
      // åˆ›å»ºXHRè¯·æ±‚ä»¥è·Ÿè¸ªè¿›åº¦
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/create/file', true);
      
      // è¿›åº¦äº‹ä»¶
      xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
          const percentComplete = Math.round((e.loaded / e.total) * 100);
          updateUploadProgress(uploadId, percentComplete);
        }
      };
      
      // å®Œæˆäº‹ä»¶
      xhr.onload = function() {
        if (xhr.status === 200) {
          completeUpload(uploadId, 'ä¸Šä¼ æˆåŠŸ');
          // åªæœ‰å½“æ‰€æœ‰ä¸Šä¼ éƒ½å®Œæˆæ—¶æ‰åˆ·æ–°é¡µé¢
          if (activeUploads === 0) {
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        } else {
          completeUpload(uploadId, 'ä¸Šä¼ å¤±è´¥');
        }
      };
      
      // é”™è¯¯äº‹ä»¶
      xhr.onerror = function() {
        completeUpload(uploadId, 'ä¸Šä¼ å¤±è´¥');
      };
      
      // å‘é€è¯·æ±‚
      xhr.send(formData);
      
      // å…³é—­æ¨¡æ€æ¡†
      closeModal('fileModal');
    });
    
    // è®¾ç½®å…¨å±€æ‹–æ‹½ä¸Šä¼ 
    function setupGlobalDragDrop() {
      const dropZone = document.body;
      let dragCounter = 0; // æ·»åŠ è®¡æ•°å™¨è·Ÿè¸ªæ‹–æ‹½çŠ¶æ€
      
      // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸ºï¼Œä½¿æ•´ä¸ªé¡µé¢å¯ä»¥æ¥æ”¶æ–‡ä»¶
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      // æ·»åŠ ä¸€ä¸ªå…¨å±€æ‹–æ‹½æç¤ºå…ƒç´ 
      const dragIndicator = document.createElement('div');
      dragIndicator.className = 'global-drag-indicator';
      dragIndicator.innerHTML = '<div class="drag-content"><span>ğŸ“</span><p>é‡Šæ”¾æ–‡ä»¶ä»¥ä¸Šä¼ </p></div>';
      document.body.appendChild(dragIndicator);
      
      // ä½¿ç”¨è®¡æ•°å™¨æ¥å¤„ç†æ‹–æ‹½çŠ¶æ€ï¼Œé¿å…é—ªçƒ
      dropZone.addEventListener('dragenter', function(e) {
        dragCounter++;
        highlight();
      }, false);
      
      dropZone.addEventListener('dragleave', function(e) {
        dragCounter--;
        if (dragCounter === 0) {
          unhighlight();
        }
      }, false);
      
      // æ‹–æ”¾æ—¶é‡ç½®è®¡æ•°å™¨å¹¶å¤„ç†æ–‡ä»¶
      dropZone.addEventListener('drop', function(e) {
        dragCounter = 0;
        unhighlight();
        handleDrop(e);
      }, false);
      
      function highlight() {
        dragIndicator.classList.add('active');
      }
      
      function unhighlight() {
        dragIndicator.classList.remove('active');
      }
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          handleFiles(files);
        }
      }
    }

    // è®¾ç½®å…¨å±€ç²˜è´´ä¸Šä¼ 
    function setupGlobalPaste() {
      document.addEventListener('paste', function(e) {
        // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ‹¦æˆª
        const activeElement = document.activeElement;
        const isInput = activeElement.tagName === 'INPUT' || 
                      activeElement.tagName === 'TEXTAREA' || 
                      activeElement.isContentEditable;
        
        if (isInput) return;
        
        // è·å–ç²˜è´´çš„æ–‡ä»¶
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        
        let hasFiles = false;
        
        for (let i = 0; i < items.length; i++) {
          if (items[i].kind === 'file') {
            const file = items[i].getAsFile();
            hasFiles = true;
            
            // åˆ›å»ºæ–‡ä»¶æ•°ç»„ä»¥åŒ¹é…handleFileså‡½æ•°å‚æ•°
            const files = [file];
            handleFiles(files);
            break;
          }
        }
        
        if (hasFiles) {
          showToast('æ­£åœ¨å¤„ç†ç²˜è´´çš„æ–‡ä»¶...', 'info');
          e.preventDefault();
        }
      });
    }

    // å¤„ç†ä¸Šä¼ æ–‡ä»¶çš„é€šç”¨å‡½æ•°
    function handleFiles(files) {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const uploadId = Date.now() + i;
        const fileName = file.name;
        
        // æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—
        addToUploadQueue(uploadId, fileName, fileName);
        
        // æ˜¾ç¤ºä¸Šä¼ UI
        document.getElementById('uploadFloatBall').style.display = 'flex';
        document.getElementById('uploadQueuePanel').classList.add('show');
        
        // åˆ›å»ºFormDataå¹¶æ·»åŠ æ–‡ä»¶
        const formData = new FormData();
        formData.append('file', file);
        formData.append('title', fileName);
        formData.append('original_filename', fileName);
        
        // å‘é€XHRè¯·æ±‚
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/create/file', true);
        
        // è¿›åº¦äº‹ä»¶
        xhr.upload.onprogress = function(e) {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            updateUploadProgress(uploadId, percentComplete);
          }
        };
        
        // å®Œæˆäº‹ä»¶
        xhr.onload = function() {
          if (xhr.status === 200) {
            completeUpload(uploadId, 'ä¸Šä¼ æˆåŠŸ');
            showToast(`æ–‡ä»¶ "${fileName}" ä¸Šä¼ æˆåŠŸ`, 'success');
            // åªæœ‰å½“æ‰€æœ‰ä¸Šä¼ éƒ½å®Œæˆæ—¶æ‰åˆ·æ–°é¡µé¢
            if (activeUploads === 0) {
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            }
          } else {
            let errorMessage = 'ä¸Šä¼ å¤±è´¥';
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.error) {
                errorMessage = response.error;
              }
            } catch (e) {}
            
            completeUpload(uploadId, errorMessage);
            showToast(`æ–‡ä»¶ "${fileName}" ${errorMessage}`, 'error');
          }
        };
        
        // é”™è¯¯äº‹ä»¶
        xhr.onerror = function() {
          completeUpload(uploadId, 'ç½‘ç»œé”™è¯¯æˆ–å¯¹è±¡ä¸ºæ–‡ä»¶å¤¹');
          showToast(`æ–‡ä»¶ "${fileName}" ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯æˆ–å¯¹è±¡ä¸ºæ–‡ä»¶å¤¹`, 'error');
        };
        
        // å‘é€è¯·æ±‚
        xhr.send(formData);
      }
    }
    
    // æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—
    function addToUploadQueue(id, title, filename) {
      const item = {
        id: id,
        title: title,
        filename: filename,
        progress: 0,
        status: 'ä¸Šä¼ ä¸­'
      };
      
      uploadQueue.push(item);
      activeUploads++;
      
      // æ›´æ–°UI
      updateUploadQueueUI();
      const floatBall = document.getElementById('uploadFloatBall');
      floatBall.style.display = 'flex';
      document.getElementById('uploadBadge').textContent = activeUploads;
      document.getElementById('uploadQueuePanel').classList.add('show');
    }
    
    // æ›´æ–°ä¸Šä¼ è¿›åº¦
    function updateUploadProgress(id, progress) {
      const item = uploadQueue.find(item => item.id === id);
      if (item) {
        item.progress = progress;
        updateUploadQueueUI();
      }
    }
    
    // å®Œæˆä¸Šä¼ 
    function completeUpload(id, status) {
      const item = uploadQueue.find(item => item.id === id);
      if (item) {
        item.progress = 100;
        item.status = status;
        activeUploads--;
        document.getElementById('uploadBadge').textContent = activeUploads;
        
        if (activeUploads === 0) {
          setTimeout(() => {
            document.getElementById('uploadFloatBall').style.display = 'none';
            document.getElementById('uploadQueuePanel').classList.remove('show');
          }, 3000);
        }
        
        updateUploadQueueUI();
      }
    }
    
    // æ›´æ–°ä¸Šä¼ é˜Ÿåˆ—UI
    function updateUploadQueueUI() {
      const container = document.getElementById('uploadItems');
      container.innerHTML = '';
      
      uploadQueue.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'upload-item';
        
        const header = document.createElement('div');
        header.className = 'upload-item-header';
        
        const title = document.createElement('div');
        title.className = 'upload-item-title';
        title.textContent = item.title || item.filename;
        
        const status = document.createElement('div');
        status.className = 'upload-item-status';
        status.textContent = item.status + ' ' + item.progress + '%';
        
        const progress = document.createElement('div');
        progress.className = 'upload-progress';
        
        const progressBar = document.createElement('div');
        progressBar.className = 'upload-progress-bar';
        progressBar.style.width = item.progress + '%';
        
        progress.appendChild(progressBar);
        header.appendChild(title);
        header.appendChild(status);
        itemEl.appendChild(header);
        itemEl.appendChild(progress);
        
        container.appendChild(itemEl);
      });
    }
    
  </script>
</body>
</html>